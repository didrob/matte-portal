<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Monster Læringsportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-game {
            font-family: 'Press Start 2P', cursive;
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        .explanation-content h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #facc15; /* yellow-400 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .explanation-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .explanation-content .example {
            background-color: #1e293b; /* slate-800 */
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #facc15; /* yellow-400 */
            margin-bottom: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-4 text-white">

    <canvas id="confetti-canvas"></canvas>

    <div id="app-container" class="w-full max-w-3xl bg-slate-800 rounded-2xl shadow-lg p-6 md:p-8 border-4 border-slate-700">
        
        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="text-center">
            <h1 class="text-3xl md:text-4xl font-game text-yellow-400 mb-8">Matte-Portalen</h1>
            <p class="text-slate-300 mb-8">Hei Erik! Hva vil du gjøre i dag?</p>
            <div class="space-y-4">
                <button data-action="start-quiz" class="w-full bg-green-500 text-slate-900 font-bold py-4 px-6 rounded-lg hover:bg-green-400 transition-transform transform hover:scale-105 shadow-lg text-xl font-game">
                    👾 Ta Utfordringen 👾
                </button>
                <button data-action="start-practice" class="w-full bg-blue-500 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-400 transition-transform transform hover:scale-105 shadow-lg text-xl font-game">
                    🧠 Gå til Øvingsrommet 🧠
                </button>
            </div>
        </div>

        <!-- Practice Hub Screen -->
        <div id="practice-hub-screen" class="hidden">
            <button class="back-to-menu-btn mb-6 text-yellow-400 font-semibold hover:text-yellow-300">&larr; Tilbake til hovedmenyen</button>
            <h1 class="text-3xl font-game text-center text-yellow-400 mb-8">Øvingsrommet</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button data-topic="brøk" class="practice-topic-btn w-full bg-slate-700 text-white font-bold py-6 px-4 rounded-lg hover:bg-slate-600 transition-colors text-lg">
                    Brøkregning
                </button>
                 <button data-topic="prosent" class="practice-topic-btn w-full bg-slate-700 text-white font-bold py-6 px-4 rounded-lg hover:bg-slate-600 transition-colors text-lg">
                    Prosent
                </button>
                 <button data-topic="geometri" class="practice-topic-btn w-full bg-slate-700 text-white font-bold py-6 px-4 rounded-lg hover:bg-slate-600 transition-colors text-lg">
                    Geometri
                </button>
                 <button data-topic="ganging" class="practice-topic-btn w-full bg-slate-700 text-white font-bold py-6 px-4 rounded-lg hover:bg-slate-600 transition-colors text-lg">
                    Ganging
                </button>
            </div>
        </div>

        <!-- Topic View Screen -->
        <div id="topic-view-screen" class="hidden">
            <button class="back-to-practice-hub-btn mb-6 text-yellow-400 font-semibold hover:text-yellow-300">&larr; Tilbake til Øvingsrommet</button>
            <h1 id="topic-title" class="text-3xl font-game text-center text-yellow-400 mb-6"></h1>
            <div id="topic-explanation" class="explanation-content bg-slate-900 p-6 rounded-lg border border-slate-700 mb-6"></div>
            <div id="topic-check" class="bg-slate-900 p-6 rounded-lg border border-slate-700">
                <h3 class="text-xl font-bold text-yellow-400 mb-4 text-center">Test deg selv!</h3>
                <p id="check-question" class="text-center mb-4"></p>
                <div id="check-answers" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <p id="check-feedback" class="text-center mt-4 font-bold"></p>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <!-- Top HUD -->
            <div class="flex justify-between items-center mb-4 bg-slate-900 p-3 rounded-lg border-2 border-slate-700">
                <button class="back-to-menu-btn text-sm text-yellow-400 hover:text-yellow-300">&larr; Avslutt</button>
                <div class="text-center">
                    <div id="monster-emoji" class="text-4xl transition-transform duration-300">🥚</div>
                    <div id="monster-name" class="text-xs font-bold text-cyan-400">Egg</div>
                </div>
                <div>
                    <span class="font-bold text-red-500">STREAK:</span>
                    <span id="streak" class="font-bold text-xl">0</span> 🔥
                </div>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-4 mb-4 border-2 border-slate-600">
                <div id="progress-bar" class="bg-green-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="question-container" class="mb-4 bg-slate-900 p-6 rounded-lg border-2 border-slate-700">
                <p id="question-text" class="text-xl md:text-2xl font-bold text-center text-white mb-6 min-h-[60px]"></p>
                <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="flex justify-end mb-2">
                <button id="hint-btn" class="text-sm text-yellow-400 hover:text-yellow-300 font-semibold transition-colors disabled:opacity-50">Hint? 💡</button>
            </div>
            <div id="hint-container" class="hidden bg-slate-700 p-4 rounded-lg mb-4 text-sm border border-slate-600"><p id="hint-text" class="text-yellow-200"></p></div>
            <div id="feedback-container" class="min-h-[50px] p-3 rounded-lg mt-4 text-center"><p id="feedback-text" class="text-lg font-bold"></p></div>
            <button id="next-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-400 transition-colors shadow-lg text-lg font-game mt-4 hidden">NESTE</button>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center">
            <h1 id="result-title" class="text-4xl font-game mb-4"></h1>
            <p class="text-slate-300 mb-6 text-lg">Du fikk <span id="final-score" class="font-bold text-yellow-400 text-2xl"></span> av 25 riktige.</p>
            <div id="result-message" class="bg-slate-900 p-6 rounded-lg mb-8 border-2"></div>
            <div id="practice-container" class="hidden text-left mb-8">
                 <h2 class="text-xl font-bold text-yellow-400 mb-3">Tips til hva du kan øve på:</h2>
                 <ul id="practice-list" class="list-disc list-inside text-slate-300 space-y-2"></ul>
            </div>
            <button id="restart-btn" class="w-full bg-yellow-500 text-slate-900 font-bold py-4 px-6 rounded-lg hover:bg-yellow-400 transition-colors shadow-lg text-xl font-game mb-4">PRØV IGJEN</button>
            <button class="back-to-menu-btn w-full bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-500 transition-colors text-lg">TIL HOVEDMENYEN</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const practiceTopics = {
            'brøk': {
                title: 'Alt om Brøk',
                explanation: `<h3>Hva er en brøk?</h3><p>Tenk deg en pizza. En brøk forteller deg hvor mange stykker du har av hele pizzaen. En brøk har to tall: en <strong>teller</strong> (oppe) og en <strong>nevner</strong> (nede).</p><div class="example">3/8 &larr; Telleren (3) sier hvor mange stykker du HAR.<br>&uarr; Nevneren (8) sier hvor mange stykker pizzaen er delt i TOTALT.</div><h3>Utvide og Forkorte Brøk</h3><p>Noen ganger kan vi skrive samme brøk på en enklere måte. Dette kalles å <strong>forkorte</strong>. Vi finner det største tallet vi kan dele både teller og nevner på.</p><div class="example">Brøken 4/8. Vi kan dele både 4 og 8 på 4.<br>4 ÷ 4 = 1<br>8 ÷ 4 = 2<br>Så 4/8 er det samme som 1/2. Det er en halv pizza!</div><p>Å <strong>utvide</strong> er det motsatte. Da ganger vi teller og nevner med det samme tallet. Dette er superviktig når vi skal legge sammen brøker.</p><h3>Legge sammen og trekke fra brøk</h3><p><strong>REGEL:</strong> Du kan KUN legge sammen eller trekke fra brøker som har <strong>lik nevner</strong> (fellesnevner)! Hvis de ikke har det, må du utvide en eller begge brøkene først.</p><div class="example">Regn ut 1/2 + 1/4.<br>1. Finn fellesnevner. Vi kan gjøre 2-tallet om til 4 ved å gange med 2.<br>2. Utvid brøken 1/2: (1*2)/(2*2) = 2/4.<br>3. Nå kan vi regne: 2/4 + 1/4 = 3/4. (Vi legger kun sammen tellerne).</div>`,
                check: { question: 'Hva blir 1/3 + 2/6?', answers: [{ text: '3/9', correct: false }, { text: '4/6 (eller 2/3)', correct: true }, { text: '3/6 (eller 1/2)', correct: false }, { text: '2/18', correct: false }], feedback: 'Riktig! Du måtte utvide 1/3 til 2/6 for å få fellesnevner. 2/6 + 2/6 = 4/6, som kan forkortes til 2/3.' }
            },
            'prosent': {
                title: 'Alt om Prosent',
                explanation: `<h3>Hva betyr prosent?</h3><p>Ordet "prosent" betyr rett og slett <strong>"per hundre"</strong> eller "hundredel". Så 25% er det samme som 25 av 100, eller brøken 25/100.</p><h3>Veien mellom brøk, desimaltall og prosent</h3><p>Disse tre er bare forskjellige måter å si det samme på. Det er lurt å kunne oversette mellom dem.</p><div class="example">Brøk: 1/4<br>Desimaltall: 1 ÷ 4 = 0.25<br>Prosent: 0.25 * 100 = 25%</div><h3>Finne prosent av et tall</h3><p>Dette er den vanligste oppgaven. For eksempel "Hva er 20% av 300?".</p><div class="example"><strong>Metode 1: Veien om 1%</strong><br>1. Finn 1% av tallet (del på 100): 300 / 100 = 3.<br>2. Gang med prosenten du vil finne: 3 * 20 = 60.<br>Svar: 20% av 300 er 60.<br><br><strong>Metode 2: Gjør om til desimaltall</strong><br>1. Gjør prosenten om til desimaltall: 20% = 0.20.<br>2. Gang med tallet: 300 * 0.20 = 60.</div>`,
                check: { question: 'En T-skjorte koster 200 kr. Du får 30% rabatt. Hva koster den?', answers: [{ text: '170 kr', correct: false }, { text: '60 kr', correct: false }, { text: '140 kr', correct: true }, { text: '30 kr', correct: false }], feedback: 'Riktig! Først finner du rabatten: 30% av 200 kr er 60 kr. Så trekker du rabatten fra prisen: 200 - 60 = 140 kr.' }
            },
            'geometri': {
                title: 'Omkrets og Areal',
                explanation: `<h3>Hva er Omkrets?</h3><p>Omkrets er <strong>lengden rundt</strong> en figur. Tenk at du skal gå en runde rundt en fotballbane. Lengden du går er omkretsen. Du finner den ved å plusse sammen lengden på alle sidene.</p><div class="example">Et rektangel har sider på 5 cm og 3 cm.<br>Omkrets = 5 + 3 + 5 + 3 = 16 cm.</div><h3>Hva er Areal?</h3><p>Areal er <strong>overflaten</strong> inni figuren. Tenk at du skal male en vegg. Arealet forteller deg hvor mye maling du trenger for å dekke hele veggen. Svaret gis i "kvadrat-enheter", som cm².</p><div class="example"><strong>Areal av rektangel: Lengde * Bredde</strong><br>Et rektangel er 5 cm langt og 3 cm bredt.<br>Areal = 5 * 3 = 15 cm².<br><br><strong>Areal av trekant: (Grunnlinje * Høyde) / 2</strong><br>En trekant har grunnlinje 6 cm og høyde 4 cm.<br>Areal = (6 * 4) / 2 = 24 / 2 = 12 cm².</div>`,
                check: { question: 'Hva er arealet av en trekant med grunnlinje 10 cm og høyde 5 cm?', answers: [{ text: '50 cm²', correct: false }, { text: '25 cm²', correct: true }, { text: '15 cm²', correct: false }, { text: '100 cm²', correct: false }], feedback: 'Helt riktig! Formelen er (grunnlinje * høyde) / 2. Altså (10 * 5) / 2 = 50 / 2 = 25 cm².' }
            },
            'ganging': {
                title: 'Ganging med store tall',
                explanation: `<h3>Hvordan gange med tall som har flere siffer?</h3><p>Å gange 23 * 14 kan virke vanskelig i hodet. Trikset er å dele opp regnestykket i biter som er enklere.</p><h3>Metode 1: Dele opp</h3><p>Du kan dele opp det ene tallet. 14 er det samme som 10 + 4.</p><div class="example">Regn ut 23 * 14.<br>1. Først, gang med tierne: 23 * 10 = 230.<br>2. Så, gang med enerne: 23 * 4 = 92.<br>3. Legg sammen svarene: 230 + 92 = 322.</div><h3>Metode 2: Standard oppstilling</h3><p>Dette er den klassiske måten man lærer på skolen, som alltid funker.</p><div class="example">  23<br>x 14<br>----<br>  92  (Her har vi regnet 4 * 23)<br> 230  (Her har vi regnet 10 * 23)<br>----<br>=322  (Her legger vi sammen 92 og 20)</div>`,
                check: { question: 'Hva er 15 * 12?', answers: [{ text: '180', correct: true }, { text: '170', correct: false }, { text: '152', correct: false }, { text: '190', correct: false }], feedback: 'Stemmer! Du kan tenke 15 * 10 = 150, og 15 * 2 = 30. Til sammen blir det 150 + 30 = 180.' }
            }
        };
        const quizData = [
            { question: "Hva er 14 * 12?", topic: "Ganging og Deling", answers: [{ text: "168", correct: true }, { text: "158", correct: false }, { text: "178", correct: false }, { text: "164", correct: false }], hint: "Del opp regnestykket! Først, gang 14 med 10 (det er 140). Deretter, gang 14 med 2 (det er 28). Til slutt legger du sammen de to svarene: 140 + 28 = ?" },
            { question: "Regn ut: 144 / 12", topic: "Ganging og Deling", answers: [{ text: "11", correct: false }, { text: "12", correct: true }, { text: "13", correct: false }, { text: "14", correct: false }], hint: "Tenk på 12-gangen. Hvilket tall må du gange med 12 for å få 144?" },
            { question: "Hva er 1/2 + 1/4?", topic: "Brøkregning", answers: [{ text: "2/6", correct: false }, { text: "1/6", correct: false }, { text: "3/4", correct: true }, { text: "2/4", correct: false }], hint: "For å legge sammen brøker, må de ha samme nevner (tallet nede). Gjør om 1/2 til fjerdedeler. Hvor mange fjerdedeler er en halv? Da kan du legge sammen tellerne (tallene oppe)." },
            { question: "Hva er 20% av 150?", topic: "Prosentregning", answers: [{ text: "20", correct: false }, { text: "30", correct: true }, { text: "25", correct: false }, { text: "35", correct: false }], hint: "For å finne 20%, kan du først finne 10% (del på 10), og deretter gange det svaret med 2." },
            { question: "Et rektangel er 9 cm langt og 7 cm bredt. Hva er arealet?", topic: "Geometri", answers: [{ text: "16 cm²", correct: false }, { text: "32 cm²", correct: false }, { text: "63 cm²", correct: true }, { text: "56 cm²", correct: false }], hint: "Arealet av et rektangel finner du ved å gange lengde med bredde." },
            { question: "Regn ut: 5.6 - 2.25", topic: "Desimaltall", answers: [{ text: "3.35", correct: true }, { text: "3.45", correct: false }, { text: "3.25", correct: false }, { text: "2.35", correct: false }], hint: "Still tallene over hverandre med kommaene på linje. Legg til en 0 etter 5.6 slik at det blir 5.60 for å gjøre det enklere." },
            { question: "Hva er 3/5 som prosent?", topic: "Brøk og Prosent", answers: [{ text: "35%", correct: false }, { text: "60%", correct: true }, { text: "53%", correct: false }, { text: "75%", correct: false }], hint: "For å gjøre om brøk til prosent, del teller på nevner (3 / 5) og gang svaret med 100." },
            { question: "En buss starter kl. 13:50. Turen tar 1 time og 25 minutter. Når er bussen fremme?", topic: "Tid og Enheter", answers: [{ text: "15:15", correct: true }, { text: "15:05", correct: false }, { text: "14:75", correct: false }, { text: "15:25", correct: false }], hint: "Legg først til timen: 13:50 + 1 time = 14:50. Legg så til 25 minutter. 10 minutter tar deg til 15:00, og da har du 15 minutter igjen." },
            { question: "Hva er 25 * 16?", topic: "Ganging og Deling", answers: [{ text: "350", correct: false }, { text: "400", correct: true }, { text: "450", correct: false }, { text: "300", correct: false }], hint: "Dette er et lurt triks! Du kan doble det ene tallet og halvere det andre: 50 * 8. Gjør det en gang til: 100 * 4. Det er mye enklere!" },
            { question: "Hva er 2/3 av 18?", topic: "Brøkregning", answers: [{ text: "6", correct: false }, { text: "9", correct: false }, { text: "12", correct: true }, { text: "15", correct: false }], hint: "Del først 18 på nevneren (3). Gang deretter svaret med telleren (2)." },
            { question: "Hva er neste tall i følgen: 5, 9, 13, 17, ...?", topic: "Algebra og Mønster", answers: [{ text: "20", correct: false }, { text: "21", correct: true }, { text: "22", correct: false }, { text: "19", correct: false }], hint: "Se på forskjellen mellom tallene. Hvor mye øker det med for hvert steg?" },
            { question: "Regn ut: 0.5 * 12", topic: "Desimaltall", answers: [{ text: "6", correct: true }, { text: "5", correct: false }, { text: "7", correct: false }, { text: "6.5", correct: false }], hint: "Å gange med 0.5 er det samme som å dele på 2. Hva er halvparten av 12?" },
            { question: "En pizza er delt i 8 biter. Du spiser 3 biter. Hvor mange prosent av pizzaen har du spist?", topic: "Brøk og Prosent", answers: [{ text: "30%", correct: false }, { text: "40%", correct: false }, { text: "37.5%", correct: true }, { text: "35%", correct: false }], hint: "Brøken er 3/8. Del 3 på 8, og gang svaret med 100 for å få prosent." },
            { question: "Hva er omkretsen av et kvadrat med sider på 6 cm?", topic: "Geometri", answers: [{ text: "36 cm", correct: false }, { text: "24 cm", correct: true }, { text: "12 cm", correct: false }, { text: "30 cm", correct: false }], hint: "Omkrets er lengden rundt hele figuren. Et kvadrat har fire like lange sider." },
            { question: "Regn ut: 99 + 156", topic: "Hoderegning", answers: [{ text: "255", correct: true }, { text: "245", correct: false }, { text: "265", correct: false }, { text: "254", correct: false }], hint: "Et triks: Legg til 100 i stedet for 99 (det blir 256), og trekk deretter fra 1." },
            { question: "Hva er 15 * 15?", topic: "Ganging og Deling", answers: [{ text: "215", correct: false }, { text: "225", correct: true }, { text: "235", correct: false }, { text: "205", correct: false }], hint: "Dette er et kvadrattall. Prøv å dele det opp: 15 * 10 = 150, og 15 * 5 = 75. Legg dem sammen." },
            { question: "Gjør om 0.8 til brøk.", topic: "Desimaltall og Brøk", answers: [{ text: "8/100", correct: false }, { text: "4/5", correct: true }, { text: "1/8", correct: false }, { text: "8/1000", correct: false }], hint: "0.8 kan skrives som 8/10. Kan du forenkle den brøken ved å dele teller og nevner på samme tall?" },
            { question: "En genser koster 400 kr. Du får 25% rabatt. Hva koster genseren?", topic: "Prosentregning", answers: [{ text: "300 kr", correct: true }, { text: "100 kr", correct: false }, { text: "325 kr", correct: false }, { text: "275 kr", correct: false }], hint: "25% er det samme som en fjerdedel. Finn først ut hvor mye rabatten er (1/4 av 400), og trekk det fra prisen." },
            { question: "Hva er 1001 - 99?", topic: "Hoderegning", answers: [{ text: "901", correct: false }, { text: "902", correct: true }, { text: "912", correct: false }, { text: "892", correct: false }], hint: "Et triks: Trekk fra 100 i stedet for 99 (det blir 901), og legg deretter til 1." },
            { question: "Hvor mange minutter er det i 3.5 timer?", topic: "Tid og Enheter", answers: [{ text: "180", correct: false }, { text: "210", correct: true }, { text: "190", correct: false }, { text: "350", correct: false }], hint: "Det er 60 minutter i en time. Gang 3 med 60. 0.5 timer er en halv time. Hvor mange minutter er det?" },
            { question: "Regn ut: 3 * 4 * 5", topic: "Ganging og Deling", answers: [{ text: "60", correct: true }, { text: "50", correct: false }, { text: "12", correct: false }, { text: "40", correct: false }], hint: "Ta det steg for steg. Først 3 * 4, og så ganger du svaret med 5." },
            { question: "Hva er 50% av 90?", topic: "Prosentregning", answers: [{ text: "40", correct: false }, { text: "50", correct: false }, { text: "45", correct: true }, { text: "35", correct: false }], hint: "50% er det samme som halvparten. Hva er halvparten av 90?" },
            { question: "En trekant har grunnlinje 10 cm og høyde 6 cm. Hva er arealet?", topic: "Geometri", answers: [{ text: "60 cm²", correct: false }, { text: "30 cm²", correct: true }, { text: "16 cm²", correct: false }, { text: "120 cm²", correct: false }], hint: "Formelen for arealet av en trekant er (grunnlinje * høyde) / 2." },
            { question: "Forenkle brøken 9/27.", topic: "Brøkregning", answers: [{ text: "1/3", correct: true }, { text: "3/9", correct: false }, { text: "1/4", correct: false }, { text: "9/27", correct: false }], hint: "Hva er det største tallet du kan dele både 9 og 27 på? Tenk på 9-gangen." },
            { question: "Hvilket tall er størst: 0.7, 0.75 eller 0.079?", topic: "Desimaltall", answers: [{ text: "0.7", correct: false }, { text: "0.079", correct: false }, { text: "0.75", correct: true }, { text: "Alle er like", correct: false }], hint: "For å sammenligne, gi dem like mange desimaler: 0.700, 0.750, og 0.079. Hvilket tall er nå størst?" }
        ];
        const monsters = [{ streak: 0, emoji: "🥚", name: "Egg" }, { streak: 3, emoji: "🦎", name: "Lizard" }, { streak: 6, emoji: "🦖", name: "Dino" }, { streak: 10, emoji: "🐉", name: "Dragon" }];
        
        // --- DOM ELEMENTS & STATE ---
        const screens = {
            menu: document.getElementById('main-menu-screen'),
            practiceHub: document.getElementById('practice-hub-screen'),
            topicView: document.getElementById('topic-view-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };
        let currentQuestionIndex, score, streak, shuffledQuestions, topicsToPractice;
        const PASSING_SCORE = 22;

        // --- NAVIGATION ---
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        document.getElementById('main-menu-screen').addEventListener('click', (e) => {
            if (e.target.dataset.action === 'start-quiz') startQuiz();
            if (e.target.dataset.action === 'start-practice') showScreen('practiceHub');
        });
        document.querySelectorAll('.back-to-menu-btn').forEach(btn => btn.addEventListener('click', () => showScreen('menu')));
        document.querySelector('.back-to-practice-hub-btn').addEventListener('click', () => showScreen('practiceHub'));

        // --- PRACTICE HUB LOGIC ---
        document.getElementById('practice-hub-screen').addEventListener('click', (e) => {
            if (e.target.classList.contains('practice-topic-btn')) {
                const topicKey = e.target.dataset.topic;
                if (practiceTopics[topicKey]) {
                    displayTopic(practiceTopics[topicKey]);
                }
            }
        });

        function displayTopic(topic) {
            document.getElementById('topic-title').innerText = topic.title;
            document.getElementById('topic-explanation').innerHTML = topic.explanation;
            
            const check = topic.check;
            document.getElementById('check-question').innerText = check.question;
            const answersContainer = document.getElementById('check-answers');
            const feedbackEl = document.getElementById('check-feedback');
            answersContainer.innerHTML = '';
            feedbackEl.innerText = '';
            feedbackEl.className = 'text-center mt-4 font-bold';
            
            shuffleArray(check.answers).forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text;
                button.classList.add('w-full', 'bg-slate-700', 'text-white', 'font-semibold', 'py-3', 'px-4', 'rounded-lg', 'hover:bg-slate-600');
                button.onclick = () => {
                    Array.from(answersContainer.children).forEach(btn => btn.disabled = true);
                    if (answer.correct) {
                        button.classList.remove('bg-slate-700');
                        button.classList.add('bg-green-500');
                        feedbackEl.innerText = check.feedback;
                        feedbackEl.classList.add('text-green-400');
                    } else {
                        button.classList.remove('bg-slate-700');
                        button.classList.add('bg-red-500');
                        feedbackEl.innerText = 'Ikke helt, prøv å lese forklaringen en gang til!';
                        feedbackEl.classList.add('text-red-400');
                    }
                };
                answersContainer.appendChild(button);
            });

            showScreen('topicView');
        }

        // --- QUIZ LOGIC ---
        const scoreEl = document.getElementById('score');
        const streakEl = document.getElementById('streak');
        const monsterEmojiEl = document.getElementById('monster-emoji');
        const monsterNameEl = document.getElementById('monster-name');
        const progressBarEl = document.getElementById('progress-bar');
        const questionTextEl = document.getElementById('question-text');
        const answerButtonsEl = document.getElementById('answer-buttons');
        const hintBtn = document.getElementById('hint-btn');
        const hintContainer = document.getElementById('hint-container');
        const hintTextEl = document.getElementById('hint-text');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTextEl = document.getElementById('feedback-text');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        
        nextBtn.addEventListener('click', setNextQuestion);
        restartBtn.addEventListener('click', startQuiz);
        hintBtn.addEventListener('click', showHint);

        function shuffleArray(array) { return array.sort(() => Math.random() - 0.5); }
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            streak = 0;
            topicsToPractice = [];
            shuffledQuestions = shuffleArray([...quizData]).slice(0, 25);
            updateHUD();
            setNextQuestion();
            showScreen('quiz');
        }
        function setNextQuestion() {
            resetState();
            if (currentQuestionIndex < shuffledQuestions.length) {
                showQuestion(shuffledQuestions[currentQuestionIndex]);
                updateProgressBar();
            } else {
                showResults();
            }
        }
        function showQuestion(question) {
            questionTextEl.innerText = question.question;
            shuffleArray(question.answers).forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text;
                button.classList.add('w-full', 'bg-slate-700', 'text-white', 'font-semibold', 'py-4', 'px-4', 'rounded-lg', 'hover:bg-slate-600', 'transition-all', 'duration-200', 'text-lg');
                if (answer.correct) button.dataset.correct = true;
                button.addEventListener('click', selectAnswer);
                answerButtonsEl.appendChild(button);
            });
        }
        function selectAnswer(e) {
            const selectedBtn = e.target;
            const isCorrect = selectedBtn.dataset.correct === "true";
            Array.from(answerButtonsEl.children).forEach(button => {
                button.disabled = true;
                if (button.dataset.correct) button.classList.add('!bg-green-500');
                else if (button === selectedBtn) button.classList.add('!bg-red-500');
            });
            if (isCorrect) {
                score++; streak++;
                const positiveFeedback = ["Superbra!", "Riktig!", "Du er en mester!", "Fortsett sånn!", "Utrolig!"];
                feedbackTextEl.innerText = positiveFeedback[Math.floor(Math.random() * positiveFeedback.length)];
                feedbackTextEl.classList.add('text-green-400');
                if (streak === 10) { runConfetti(); feedbackTextEl.innerText = "MEGA-STREAK! 10 PÅ RAD!"; }
            } else {
                streak = 0;
                feedbackTextEl.innerText = "Nesten! Riktig svar er markert.";
                feedbackTextEl.classList.add('text-red-400');
                topicsToPractice.push(shuffledQuestions[currentQuestionIndex].topic);
            }
            updateHUD();
            nextBtn.classList.remove('hidden');
            currentQuestionIndex++;
        }
        function updateHUD() {
            // scoreEl is not defined yet because the quiz screen is hidden
            // This is a placeholder until we define the elements inside the quiz screen
            const scoreDisplay = document.querySelector('#quiz-screen #score');
            const streakDisplay = document.querySelector('#quiz-screen #streak');

            if(scoreDisplay) scoreDisplay.innerText = score;
            if(streakDisplay) streakDisplay.innerText = streak;

            const currentMonster = monsters.slice().reverse().find(m => streak >= m.streak);
            if (monsterNameEl.innerText !== currentMonster.name) {
                monsterEmojiEl.classList.add('transform', 'scale-150');
                setTimeout(() => monsterEmojiEl.classList.remove('transform', 'scale-150'), 300);
            }
            monsterEmojiEl.innerText = currentMonster.emoji;
            monsterNameEl.innerText = currentMonster.name;
        }
        function updateProgressBar() {
            progressBarEl.style.width = `${(currentQuestionIndex / shuffledQuestions.length) * 100}%`;
        }
        function resetState() {
            nextBtn.classList.add('hidden');
            hintContainer.classList.add('hidden');
            hintBtn.disabled = false;
            feedbackTextEl.innerText = '';
            feedbackTextEl.className = 'text-lg font-bold';
            while (answerButtonsEl.firstChild) answerButtonsEl.removeChild(answerButtonsEl.firstChild);
        }
        function showHint() {
            hintTextEl.innerText = shuffledQuestions[currentQuestionIndex].hint;
            hintContainer.classList.remove('hidden');
            hintBtn.disabled = true;
        }
        function showResults() {
            const resultTitle = document.getElementById('result-title');
            const resultMessageEl = document.getElementById('result-message');
            document.getElementById('final-score').innerText = score;
            resultTitle.className = 'text-4xl font-game mb-4';
            resultMessageEl.className = 'bg-slate-900 p-6 rounded-lg mb-8 border-2';
            if (score >= PASSING_SCORE) {
                resultTitle.innerText = "DU KLARTE DET!";
                resultTitle.classList.add('text-green-400');
                resultMessageEl.innerHTML = `<h2 class="text-xl font-bold text-yellow-400 mb-2">GRATULERER!</h2><p class="text-lg text-white">Du vant utfordringen! Gjør deg klar for overnatting i stua! 🥳</p>`;
                resultMessageEl.classList.add('border-green-500');
                runConfetti();
            } else {
                resultTitle.innerText = "Nesten...";
                resultTitle.classList.add('text-red-400');
                resultMessageEl.innerHTML = `<h2 class="text-xl font-bold text-yellow-400 mb-2">Godt forsøk!</h2><p class="text-lg text-white">Du var bare ${PASSING_SCORE - score} poeng unna. Ta en liten pause og prøv igjen, dette klarer du!</p>`;
                resultMessageEl.classList.add('border-red-500');
            }
            displayPracticeTopics();
            showScreen('result');
        }
        function displayPracticeTopics() {
            const practiceContainer = document.getElementById('practice-container');
            const practiceList = document.getElementById('practice-list');
            practiceList.innerHTML = '';
            if (topicsToPractice.length === 0) {
                practiceContainer.classList.add('hidden');
                return;
            }
            const topicCounts = topicsToPractice.reduce((acc, topic) => { acc[topic] = (acc[topic] || 0) + 1; return acc; }, {});
            const sortedTopics = Object.keys(topicCounts).sort((a, b) => topicCounts[b] - topicCounts[a]);
            practiceContainer.classList.remove('hidden');
            sortedTopics.slice(0, 3).forEach(topic => {
                const li = document.createElement('li');
                li.textContent = topic;
                practiceList.appendChild(li);
            });
        }
        function runConfetti() {
            const confettiCanvas = document.getElementById('confetti-canvas');
            const ctx = confettiCanvas.getContext('2d');
            const W = window.innerWidth;
            const H = window.innerHeight;
            confettiCanvas.width = W;
            confettiCanvas.height = H;
            const particles = [];
            const particleCount = 150;
            const colors = ["#4ade80", "#facc15", "#60a5fa", "#f87171", "#a78bfa"];
            for (let i = 0; i < particleCount; i++) {
                particles.push({ x: Math.random() * W, y: Math.random() * -H, w: Math.random() * 10 + 5, h: Math.random() * 10 + 5, vx: Math.random() * 20 - 10, vy: Math.random() * 10 + 5, color: colors[Math.floor(Math.random() * colors.length)], angle: Math.random() * Math.PI * 2, spin: Math.random() * 0.2 - 0.1 });
            }
            let animationFrame;
            function draw() {
                ctx.clearRect(0, 0, W, H);
                particles.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x + p.w / 2, p.y + p.h / 2);
                    ctx.rotate(p.angle);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                    ctx.restore();
                    p.y += p.vy; p.x += p.vx; p.angle += p.spin;
                    if(p.y > H) { p.x = Math.random() * W; p.y = -50; }
                });
                animationFrame = requestAnimationFrame(draw);
            }
            draw();
            setTimeout(() => { cancelAnimationFrame(animationFrame); ctx.clearRect(0, 0, W, H); }, 4000);
        }
    </script>
</body>
</html>
